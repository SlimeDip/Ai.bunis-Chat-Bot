<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ai.bunis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1 class="logo">Ai.bunis</h1>

    <div class="container">
        <ul class="chatbox" id="chatbox">
            <li class="chat-incoming chat">
                <img src="{{ url_for('static', filename='Aibunis_pic.png') }}" alt="Aibunis" class="avatar">
                <p>Hey! How can I assist you today?</p>
            </li>
        </ul>

        <form class="chat-input" id="chatForm" autocomplete="off">
            <textarea name="prompt" rows="1" cols="50" placeholder="Enter a message..." required></textarea>
            <button type="submit" class="submit_btn" id="send_btn">Send</button>
        </form>
    </div>

    <script>
        const chatbox = document.getElementById('chatbox');
        const chatForm = document.getElementById('chatForm');
        const textarea = chatForm.elements['prompt'];

        textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    chatForm.dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}));
                }
            });

        chatForm.addEventListener('submit', async function(e) {

            e.preventDefault();
            const prompt = textarea.value.trim();
            
            if (!prompt) return;

            textarea.value = '';

            const userLi = document.createElement('li');
            userLi.className = 'chat-outgoing chat';
            userLi.innerHTML = `<p>${prompt}</p>`;
            chatbox.appendChild(userLi);

            chatbox.scrollTop = chatbox.scrollHeight;

            const loadLi = document.createElement('li');
            loadLi.className = 'loading';
            loadLi.innerHTML = `<img src="{{ url_for('static', filename='Aibunis_pic.png') }}" alt="Aibunis" class="avatar"><p>. . .</p>`;
            chatbox.appendChild(loadLi);

            chatbox.scrollTop = chatbox.scrollHeight;

            const response = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({prompt})
            });
            const data = await response.json();

            loadLi.remove()

            const aiLi = document.createElement('li');
            aiLi.className = 'chat-incoming chat';
            aiLi.innerHTML = `<img src="{{ url_for('static', filename='Aibunis_pic.png') }}" alt="Aibunis" class="avatar"><p>${data.ai_message}</p>`;
            chatbox.appendChild(aiLi);

            chatbox.scrollTop = chatbox.scrollHeight;
        });
    </script>
</body>
</html>